# [Troubleshooting] MongoDB 스키마 분산으로 인한 모델 중복 등록 및 컬렉션 설정 충돌 위험

## 1. 문제 상황 (Issue)

* **환경**: NestJS + MongoDB(Mongoose) 백엔드
* **현상**

1. 스키마가 기능별 폴더에 흩어져 있어, 스키마 수정이 곧 기능 모듈 수정으로 이어지는 구조였습니다.
2. 일부 모듈에서 동일 모델을 여러 번 등록하는 흐름이 생기면서, 설정이 꼬일 가능성이 있었습니다.
3. RAG 확장(문서/청크 단위 데이터)까지 고려하면 스키마/인덱스 정책을 일관되게 유지하기 어렵다고 판단했습니다.

---

## 2. 원인 분석 (Root Cause)

1. **스키마가 도메인 모듈에 종속된 구조**

   * DB 모델이 특정 기능 코드와 같이 움직여 변경 영향 범위가 커졌습니다.

2. **모델 등록이 분산되어 생기는 중복/충돌 가능성**

   * 같은 모델이 여러 위치에서 등록되면, 설정(컬렉션명 override 등)이 섞이거나 예상과 다르게 주입될 수 있습니다.

3. **인덱스/컬렉션 정책이 분산**

   * 최적화 포인트가 흩어져 있어 관리가 어려웠습니다.

---

## 3. 해결 과정 (Step-by-Step)

1. 스키마를 공통 DB 레이어로 이동하여 한 곳에서 관리하도록 정리했습니다.
2. 모델 등록을 공통 DatabaseModule로 일원화해 중복 등록을 제거했습니다.
3. 기능 모듈은 DB 레이어에서 스키마를 import해서 사용하도록 구조를 단순화했습니다.
4. 기존 기능이 동일하게 동작하는지 기본 플로우를 스모크 테스트로 확인했습니다.

---

## 4. 결과 및 교훈 (Lessons Learned)

* **결과**

  * 스키마/모델 등록이 단일 지점에서 관리되어 구조가 단순해졌습니다.
  * 중복 등록 제거로 설정 충돌 가능성이 줄었습니다.
  * RAG 확장 시에도 스키마 추가/수정 흐름이 명확해졌습니다.

* **교훈**

  * DB 모델을 초기에 분리해두면, 확장 단계에서 유지보수 비용이 확 줄어듭니다.